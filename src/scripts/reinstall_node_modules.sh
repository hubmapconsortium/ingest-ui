#!/usr/bin/env bash
set -euo pipefail
# Ensure ERR traps are inherited in subshells/functions
set -E

# Print helpful diagnostics on errors
trap 'rc=$?; echo "Error in ${BASH_SOURCE[0]} at line $LINENO: $BASH_COMMAND (exit $rc)" >&2; exit $rc' ERR

# Determine the src directory (parent of this scripts directory)
SRC_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

echo "Removing $SRC_DIR/node_modules and $SRC_DIR/package-lock.json"
rm -rf "$SRC_DIR/node_modules"
rm -f "$SRC_DIR/package-lock.json"

echo "Running npm install in $SRC_DIR" 
(cd "$SRC_DIR" && npm install)

echo "Committing package-lock.json if it changed"
cd "$SRC_DIR"

# Only add and commit package-lock.json if it exists and has changes
if [ -f package-lock.json ]; then
  if [ -n "$(git status --porcelain -- package-lock.json)" ]; then
    git add package-lock.json
    git commit -m "Purge & Install node_modules and package-lock.json | DependabotManagement"
    echo "Committed package-lock.json."
  else
    echo "No changes in package-lock.json to commit."
  fi
else
  echo "No package-lock.json present."
fi

echo "Done."
