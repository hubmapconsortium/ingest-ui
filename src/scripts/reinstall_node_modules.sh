#!/usr/bin/env bash
set -euo pipefail
# Ensure ERR traps are inherited in subshells/functions
set -E

# Print helpful diagnostics on errors
trap 'rc=$?; echo "Error in ${BASH_SOURCE[0]} at line $LINENO: $BASH_COMMAND (exit $rc)" >&2; exit $rc' ERR

# Determine the src directory (parent of this scripts directory)
SRC_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

echo "Removing $SRC_DIR/node_modules and $SRC_DIR/package-lock.json"
rm -rf "$SRC_DIR/node_modules"
rm -f "$SRC_DIR/package-lock.json"

echo "Running npm install in $SRC_DIR" 
(cd "$SRC_DIR" && npm install)

echo "Staging changes and committing if any"
cd "$SRC_DIR"
git add -A
if git diff --cached --quiet; then
  echo "No changes to commit."
else
  git commit -m "Reinstall node_modules and update package-lock.json"
  echo "Committed changes."
fi

echo "Done."
